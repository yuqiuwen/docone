"use strict";(self.webpackChunkdocone=self.webpackChunkdocone||[]).push([[8524],{24531:(e,r,n)=>{n.r(r),n.d(r,{assets:()=>p,contentTitle:()=>c,default:()=>d,frontMatter:()=>o,metadata:()=>a,toc:()=>l});var t=n(85893),i=n(11151);const o={title:"Apple\u5185\u8d2d\u9a8c\u7b7e\u6d41\u7a0b",authors:"Qiuwen",description:"",tags:["\u8ba2\u5355\u7cfb\u7edf","Apple\u5185\u8d2d"],date:new Date("2024-11-28T10:30:00.000Z")},c=void 0,a={permalink:"/docone/blog/2024/11/28/apple/verify-receipt",source:"@site/blog/2024-11-28-apple/verify-receipt.md",title:"Apple\u5185\u8d2d\u9a8c\u7b7e\u6d41\u7a0b",description:"",date:"2024-11-28T10:30:00.000Z",formattedDate:"November 28, 2024",tags:[{label:"\u8ba2\u5355\u7cfb\u7edf",permalink:"/docone/blog/tags/\u8ba2\u5355\u7cfb\u7edf"},{label:"Apple\u5185\u8d2d",permalink:"/docone/blog/tags/apple\u5185\u8d2d"}],readingTime:2.04,hasTruncateMarker:!1,authors:[{name:"Qiuwen",title:"FullStack Engineer @ Facebook",url:"https://github.com/yuqiuwen",key:"Qiuwen"}],frontMatter:{title:"Apple\u5185\u8d2d\u9a8c\u7b7e\u6d41\u7a0b",authors:"Qiuwen",description:"",tags:["\u8ba2\u5355\u7cfb\u7edf","Apple\u5185\u8d2d"],date:"2024-11-28T10:30:00.000Z"},unlisted:!1,nextItem:{title:"Redis",permalink:"/docone/blog/2024/02/04/Redis"}},p={authorsImageUrls:[void 0]},l=[];function s(e){const r={a:"a",br:"br",li:"li",mermaid:"mermaid",ol:"ol",p:"p",strong:"strong",...(0,i.a)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)(r.p,{children:[(0,t.jsx)(r.strong,{children:"\u9a8c\u8bc1\u9879\uff1a"}),(0,t.jsx)(r.br,{}),"\n\u9488\u5bf9\u65e7\u7248\u9a8c\u8bc1api\uff1a",(0,t.jsx)(r.a,{href:"https://developer.apple.com/documentation/appstorereceipts/verifyreceipt",children:"https://developer.apple.com/documentation/appstorereceipts/verifyreceipt"}),"\n\u4e3a\u4e86\u9a8c\u8bc1\u6536\u636e\u4f2a\u9020\u7b49\u60c5\u51b5\uff0c\u9700\u9a8c\u8bc1\u4ee5\u4e0b\u51e0\u70b9\uff1a"]}),"\n",(0,t.jsxs)(r.ol,{children:["\n",(0,t.jsxs)(r.li,{children:["receipt.environment\uff0c\u533a\u5206\u8ba2\u5355\u73af\u5883\uff08\u751f\u4ea7\u6216\u6c99\u76d2\uff09\uff0c\u82e5\u8fd4\u56de21007\u8868\u793a\u6c99\u76d2\u73af\u5883\uff0c\u6b64\u65f6\u9700\u7528\u6c99\u76d2api\u518d\u6b21\u9a8c\u8bc1",(0,t.jsx)(r.a,{href:"https://sandbox.itunes.apple.com/verifyReceipt%EF%BC%8C%E6%96%B9%E4%BE%BF%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%9C%A8%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83%E8%BF%9B%E8%A1%8C%E6%B5%8B%E8%AF%95%E8%80%8C%E4%B8%8D%E7%94%A8%E6%9D%A5%E5%9B%9E%E5%88%87%E6%8D%A2%E7%8E%AF%E5%A2%83",children:"https://sandbox.itunes.apple.com/verifyReceipt\uff0c\u65b9\u4fbf\u5ba2\u6237\u7aef\u5728\u751f\u4ea7\u73af\u5883\u8fdb\u884c\u6d4b\u8bd5\u800c\u4e0d\u7528\u6765\u56de\u5207\u6362\u73af\u5883"})]}),"\n",(0,t.jsx)(r.li,{children:"receipt.status == 0\uff0c\u4e3a0\u8868\u793a\u6709\u6548"}),"\n",(0,t.jsx)(r.li,{children:"order.product_id in product\uff0c\u7cfb\u7edf\u4e2d\u5546\u54c1\u662f\u5426\u5b58\u5728"}),"\n",(0,t.jsx)(r.li,{children:"receipt.product_id == order.product_id\uff0c\u6536\u636e\u8fd4\u56de\u7684\u5546\u54c1id\u662f\u5426\u548c\u8ba2\u5355\u7684\u5546\u54c1id\u4e00\u81f4"}),"\n",(0,t.jsx)(r.li,{children:"receipt.bundle_id == product.bundle_id\uff0c\u4e0d\u540cbundle_id\u4e4b\u95f4\u7684product_id\u53ef\u80fd\u91cd\u590d\uff0c\u82e5\u6709\u591a\u4e2a\u5305\uff0c\u7cfb\u7edf\u53ef\u5355\u72ec\u7ba1\u7406\u5185\u8d2d\u5546\u54c1\uff0c\u6b64\u65f6\u8ba2\u5355\u4e2d\u7684product_id\u5e94\u8be5\u4e3aproduct\u8868\u7684\u4e3b\u952eid"}),"\n",(0,t.jsx)(r.li,{children:"receipt.transaction_id\uff0c\u68c0\u67e5\u5546\u6237id\u662f\u5426\u5df2\u5b58\u5728\u4e8e\u8ba2\u5355\u8bb0\u5f55\u4e2d\uff0c\u82e5\u5b58\u5728\u8868\u793a\u5df2\u9a8c\u7b7e\uff0c\u53ef\u5c06 (pay_type, transaction_id) \u4f5c\u4e3a\u8054\u5408\u552f\u4e00\u7d22\u5f15"}),"\n",(0,t.jsx)(r.li,{children:"receipt.cancellation_date\uff0c\u5982\u679creceipt\u4e2d\u5305\u542bcancellation_date\u5c5e\u6027\uff0c\u8bf4\u660e\u4ea4\u6613\u88ab\u53d6\u6d88\u6216\u9000\u6b3e"}),"\n",(0,t.jsx)(r.li,{children:"order.ctime < receipt.purchase_date_ms\uff0c\u6b63\u5e38\u60c5\u51b5\u5e94\u8be5\u662f\u4e0b\u5355\u65f6\u95f4\u5c0f\u4e8e\u6536\u636e\u4e2d\u7684\u8d2d\u4e70\u65f6\u95f4\uff0c\u524d\u63d0\u662f\u7cfb\u7edf\u65f6\u95f4order.ctime\u51c6\u786e\u65e0\u8bef"}),"\n"]}),"\n",(0,t.jsx)(r.p,{children:(0,t.jsx)(r.strong,{children:"\u6d41\u7a0b\u56fe\uff1a"})}),"\n",(0,t.jsx)(r.mermaid,{value:"sequenceDiagram\n    actor Client\n    participant Server\n    participant Apple Server\n    participant MQ\n\n    \n    Client ->> Server: query product info\n    Server ->> Client: return product\n    Client ->>+ Server: request orderId\n    Server ->> Server: create order\n    Server ->> MQ: send delay message (check order state after 15 min)\n    Server ->>- Client: return orderId\n    Client ->>+ Apple Server: pay\n    Apple Server ->>- Client: return receipt\n    Client ->>+ Server: verify\n    Server ->> Server: query order\n\n    alt not exists ?\n        Server ->> Client: return error\n    else exists\n        Server ->>- Apple Server: verify receipt\n        Apple Server ->> Server: return result\n        alt passed\n            Server ->> Client: return success\n        else else\n            Server ->> Client: return failed\n        end\n    end\n    \n    MQ ->>+ Server: deliver message\n    Server ->> Server: check order state\n    alt unpaid\n        Server ->>- Server: marked as canceled\n    end\n   \n"})]})}function d(e={}){const{wrapper:r}={...(0,i.a)(),...e.components};return r?(0,t.jsx)(r,{...e,children:(0,t.jsx)(s,{...e})}):s(e)}},11151:(e,r,n)=>{n.d(r,{Z:()=>a,a:()=>c});var t=n(67294);const i={},o=t.createContext(i);function c(e){const r=t.useContext(o);return t.useMemo((function(){return"function"==typeof e?e(r):{...r,...e}}),[r,e])}function a(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:c(e.components),t.createElement(o.Provider,{value:r},e.children)}}}]);